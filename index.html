<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patchcoin Claims Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #2563eb;
        --success-color: #16a34a;
        --peercoin-color: #f59e0b;
        --warning-color: #ef4444;
        --background-color: #f8f9fa;
        --card-background: #ffffff;
        --border-color: #e5e7eb;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --fill-color: rgba(22, 163, 44, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: var(--background-color);
        color: var(--text-primary);
        line-height: 1.5;
        padding: 1rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
      }

      .card {
        background: var(--card-background);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      h1 {
        font-size: 1.875rem;
        font-weight: 700;
        text-align: center;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
      }

      h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
      }

      h3 {
        font-size: 1.25rem;
        font-weight: 500;
        color: var(--text-primary);
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
      }

      #chartContainer {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 2rem;
      }

      .progress-container {
        margin-top: 2rem;
      }

      .progress-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .progress-value {
        font-weight: 600;
      }

      .progress-eligible {
        color: var(--primary-color);
      }

      .progress-received {
        color: var(--success-color);
      }

      .progress-peercoin {
        color: var(--peercoin-color);
      }

      .progress {
        background: #e9ecef;
        border-radius: 9999px;
        overflow: hidden;
        height: 1rem;
      }

      .progress-bar {
        height: 100%;
        transition: width 0.5s ease;
        border-radius: 9999px;
      }

      .progress-group {
        margin-bottom: 1.5rem;
      }

      #capProgressEligible {
        background: var(--primary-color);
      }

      #capProgressReceived {
        background: var(--success-color);
      }

      #capProgressPeercoin {
        background: var(--peercoin-color);
      }

      .progress-subtitle {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-align: right;
        margin-top: 0.25rem;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        table-layout: auto;
      }

      table, th, td {
        border: 1px solid #ddd;
      }

      th, td {
        padding: 8px;
        text-align: left;
        white-space: nowrap;
      }

      th.number, td.number {
        text-align: right;
      }

      th.id-column, td.id-column {
        width: 70px;
        max-width: 70px;
      }

      th {
        background: #f2f2f2;
      }

      .truncate {
        max-width: 200px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      .full-address {
        position: absolute;
        left: -9999px;
        height: 1px;
        width: 1px;
        overflow: hidden;
        opacity: 0;
      }

      .claim-id {
        font-weight: 600;
        color: var(--primary-color);
        margin-right: 4px;
      }

      .claim-link {
        color: var(--primary-color);
        text-decoration: none;
        cursor: pointer;
        font-size: 0.85em;
      }

      .chart-tooltip {
        background: var(--card-background);
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
        font-size: 0.875rem;
      }

      .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .pagination button {
        padding: 0.4rem 0.7rem;
        border: 1px solid var(--border-color);
        background: var(--card-background);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-primary);
        font-size: 0.85rem;
      }

      .pagination button:hover {
        background: var(--background-color);
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .pagination-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 24px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }

      input:checked + .toggle-slider {
        background-color: var(--primary-color);
      }

      input:checked + .toggle-slider:before {
        transform: translateX(36px);
      }

      .search-container input {
        padding: 0.5rem 1rem;
        width: 100%;
        max-width: 400px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
      }

      .controls-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .claim-id {
        font-weight: 600;
        color: var(--primary-color);
      }

      .claim-row {
        scroll-margin-top: 20px;
      }

      .claim-link {
        color: var(--primary-color);
        text-decoration: none;
        cursor: pointer;
      }

      .claim-link:hover {
        text-decoration: underline;
      }

      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--primary-color);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
      }

      textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-family: monospace;
        resize: vertical;
      }

      #checker-view button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
      }

      #checker-view button:hover {
        background-color: #1d4ed8;
      }

      input[type="file"] {
        margin: 0.5rem 0;
        cursor: pointer;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
      }

      .tab {
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        transition: all 0.2s;
      }

      .tab.active {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      #output {
        background-color: #f3f4f6;
        white-space: pre-wrap;
        word-break: break-all;
        font-family: monospace;
        overflow-y: auto;
        margin-top: 0.5rem;
      }

      #output table {
        margin-top: 0 !important;
      }

      .output-container {
        margin-top: 1.5rem;
      }

      .output-status {
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .status-success {
        color: var(--success-color);
      }

      .status-warning {
        color: var(--peercoin-color);
      }

      .update-controls {
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
      }

      .update-status-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }

      .update-note {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-style: italic;
      }

      .small-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .hidden {
        display: none;
      }

      .nav-links {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .nav-link {
        color: var(--text-primary);
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .nav-link:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }

      .nav-link.active {
        color: var(--primary-color);
        font-weight: 500;
        background-color: rgba(37, 99, 235, 0.1);
      }

      @media (min-width: 1200px) {
        .card {
          padding-left: 1rem;
          padding-right: 1rem;
        }

        th, td {
          padding-left: 6px;
          padding-right: 6px;
        }

        .truncate {
          max-width: 190px;
        }
      }

      @media (max-width: 768px) {
        body { padding: 0.5rem; }
        .container { padding: 0.5rem; }
        .card { padding: 1rem; }
        h1 { font-size: 1.5rem; }
        #chartContainer { height: 300px; }
        .progress { height: 0.75rem; }
        .pagination button { padding: 0.4rem 0.8rem; font-size: 0.875rem; }
        .tab { padding: 0.5rem 1rem; }
        .nav-links { flex-direction: column; gap: 0.5rem; align-items: center; }
      }

      @media (max-width: 480px) {
        #chartContainer { height: 250px; }
        .progress-label { font-size: 0.875rem; }
        .progress-subtitle { font-size: 0.75rem; }
      }
    </style>
  </head>
  <body>
    <div id="toast" class="toast"></div>
    <div class="container">
      <h1>Patchcoin Claims</h1>

      <div class="nav-links">
        <a href="#dashboard" class="nav-link active" onclick="switchView('dashboard', event)">Dashboard</a>
        <a href="#checker" class="nav-link" onclick="switchView('checker', event)">Address Checker</a>
      </div>

      <div id="dashboard-view">
        <div class="card">
          <div id="chartContainer">
            <canvas id="claimsChart"></canvas>
          </div>
          <div class="progress-container">
            <div class="progress-group">
              <div class="progress-label">
                <span>Eligible Progress</span>
                <span class="progress-value progress-eligible" id="eligiblePercent">0%</span>
              </div>
              <div class="progress">
                <div id="capProgressEligible" class="progress-bar"></div>
              </div>
              <div class="progress-subtitle" id="eligibleSubtitle">0 / 21,000,000</div>
            </div>
            <div class="progress-group">
              <div class="progress-label">
                <span>Received Progress</span>
                <span class="progress-value progress-received" id="receivedPercent">0%</span>
              </div>
              <div class="progress">
                <div id="capProgressReceived" class="progress-bar"></div>
              </div>
              <div class="progress-subtitle" id="receivedSubtitle">0 / 21,000,000</div>
            </div>
            <div class="progress-group">
              <div class="progress-label">
                <span>Peercoins Used</span>
                <span class="progress-value progress-peercoin" id="peercoinPercent">0%</span>
              </div>
              <div class="progress">
                <div id="capProgressPeercoin" class="progress-bar"></div>
              </div>
              <div class="progress-subtitle" id="peercoinSubtitle">0 / 29,405,803</div>
            </div>
          </div>
          <div class="controls-wrapper">
            <div class="pagination-container">
              <div class="pagination-toggle">
                <label for="paginationToggle">Show all claims</label>
                <label class="toggle-switch">
                  <input type="checkbox" id="paginationToggle">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div id="paginationControls"></div>
            </div>
            <div class="search-container">
              <input id="searchInput" type="text" placeholder="Search...">
            </div>
          </div>
          <div class="table-container">
            <table id="claimsTable">
              <thead>
                <tr>
                  <th class="id-column">ID</th>
                  <th>Time</th>
                  <th>Peercoin Address</th>
                  <th>Patchcoin Address</th>
                  <th class="number">Peercoin Balance</th>
                  <th class="number">Patchcoin Eligible</th>
                  <th class="number">Total Received</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="checker-view" class="hidden">
        <div class="card">
          <h2>Patchcoin Address Checker</h2>
          <p>Check if your Peercoin addresses have been included in the claims. Missing addresses will be displayed below.</p>
          <p><a href="https://patchcointalk.org/t/ensuring-dust-has-been-claimed/83" target="_blank">Detailed guide</a></p>

          <div class="tabs">
            <div class="tab active" onclick="switchTab('tab1', this)">Plain Address List</div>
            <div class="tab" onclick="switchTab('tab2', this)">Pasted listreceivedbyaddress.json</div>
            <!--<div class="tab" onclick="switchTab('tab3', this)">Uploaded listreceivedbyaddress.json</div>-->
          </div>

          <div id="tab1" class="tab-content active">
            <h3>Check from Plain Address List</h3>
            <textarea id="addressInput" rows="6" placeholder="Enter one Peercoin address per line"></textarea>
            <br>
            <button onclick="checkAddresses('text')">Check Addresses</button>
          </div>

          <div id="tab2" class="tab-content">
            <h3>Check from Pasted listreceivedbyaddress.json</h3>
            <textarea id="jsonInput" rows="6" placeholder="Paste listreceivedbyaddress.json here"></textarea>
            <br>
            <button onclick="checkAddresses('json')">Check JSON</button>
          </div>

          <!--
          <div id="tab3" class="tab-content">
            <h3>Check from Uploaded listreceivedbyaddress.json</h3>
            <input type="file" id="jsonFile" accept="application/json">
            <button onclick="checkAddresses('file')">Check JSON</button>
          </div>
          -->

          <div class="output-container">
            <h3>Results</h3>
            <div id="status" class="output-status"></div>
            <div id="loader" class="loader hidden"></div>
            <pre id="output">Results will appear here after checking.</pre>
          </div>

          <div class="update-controls">
            <div class="update-status-container">
              <span id="updateStatus">Updates paused</span>
              <button id="toggleUpdatesBtn" class="small-button" onclick="toggleUpdates(!updatesPaused)">Resume Updates</button>
              <!--<button class="small-button" onclick="updateDashboard(true)">Force Update</button>-->
            </div>
            <p class="update-note">Updates are automatically paused while on this tab.</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const DATA_URL = 'https://raw.githubusercontent.com/patchcoin/claims-made/refs/heads/main/claims.json';
      const REFERENCE_SET = 'https://raw.githubusercontent.com/patchcoin/claims-made/refs/heads/site/peercoin-txoutset-795000.json';
      const CAP = 21000000;
      let chart;
      window.toggleStates = {};
      let claimsAddressSet = null;
      let updatesPaused = false;
      let updateInterval = null;
      let lastDataHash = null;

      let currentPage = 1;
      let totalPages = 1;
      let rowsPerPage = 10;
      let allClaimsData = [];
      let lastData = null;
      let paginationEnabled = true;
      let firstLoad = true;

      function formatNumber(num) {
        return new Intl.NumberFormat('en-US', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(num);
      }

      function truncatedAddress(addr) {
        return addr.length > 18 ? addr.slice(0, 18) + "..." : addr;
      }

      function createTooltipHtml(context) {
        if (!context[0]) return '';
        const idx = context[0].dataIndex;
        const claim = window.sortedClaims[idx];
        if (!claim) return '';
        const datasetLines = context.map(item => {
          return `<div style="color: ${item.dataset.borderColor};">
            ${item.dataset.label}: ${formatNumber(item.parsed.y)}
          </div>`;
        }).join('');

        return `
          <div class="chart-tooltip">
            <div style="font-weight: 600; margin-bottom: 8px;">${context[0].label}</div>
            ${datasetLines}
            <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
              <div>Claim ID: ${idx + 1}</div>
              <div>Peercoin: ${truncatedAddress(claim.peercoin_address)}</div>
              <div>Patchcoin: ${truncatedAddress(claim.patchcoin_address)}</div>
              <div>Balance: ${formatNumber(claim.peercoin_balance)}</div>
            </div>
          </div>
        `;
      }

      function generateDataHash(data) {
        if (!data || !data.length) return "empty";

        const claimCount = data.length;
        const timeSum = data.reduce((sum, item) => sum + item.nTime, 0);
        const receivedSum = data.reduce((sum, item) => sum + item.total_received, 0);

        return `${claimCount}-${timeSum}-${receivedSum}`;
      }

      function hasDataChanged(newData) {
        const newHash = generateDataHash(newData);
        if (lastDataHash === null) {
          lastDataHash = newHash;
          return true;
        }

        if (newHash !== lastDataHash) {
          lastDataHash = newHash;
          return true;
        }

        return false;
      }

      function getPageForIndex(index) {
        if (index < 0) return 1;
        return Math.floor(index / rowsPerPage) + 1;
      }

      function paginateData(data) {
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        return data.slice(startIndex, endIndex);
      }

      function findInProgressIndex(data) {
        return data.findIndex(item =>
          item.total_received > 0 && item.total_received < item.patchcoin_eligible
        );
      }

      function getClaimIdFromGlobalIndex(globalIndex, filteredData) {
        if (filteredData !== allClaimsData) {
          const item = filteredData[globalIndex];
          return allClaimsData.findIndex(claim =>
            claim.peercoin_address === item.peercoin_address &&
            claim.patchcoin_address === item.patchcoin_address &&
            claim.nTime === item.nTime
          ) + 1;
        }
        return globalIndex + 1;
      }

      function showToast(message, duration = 2000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.opacity = '1';

        setTimeout(() => {
          toast.style.opacity = '0';
        }, duration);
      }

      function handleLinkCopy(e, claimId, localIndex) {
        e.preventDefault();

        let url = new URL(window.location.href);
        url.hash = 'dashboard';
        url.searchParams.set('claim', claimId);

        if (paginationEnabled) {
          const targetPage = getPageForIndex(claimId - 1);
          url.searchParams.set('page', targetPage);
        }

        navigator.clipboard.writeText(url.href)
                .then(() => {
                  showToast(`Link to claim #${claimId} copied!`);
                })
                .catch(err => {
                  console.error('Error copying to clipboard:', err);
                  showToast(`Could not copy link. URL: ${url.href}`);
                });
      }

      function scrollToClaimFromHash() {
        const hash = window.location.hash;
        if (!hash.startsWith('#claim-')) return;

        const targetClaimId = parseInt(hash.substring(7));
        if (isNaN(targetClaimId) || targetClaimId < 1 || targetClaimId > allClaimsData.length) return;

        if (document.getElementById('dashboard-view').classList.contains('hidden')) {
          switchView('dashboard');
          document.querySelector('a[href="#dashboard"]').classList.add('active');
          document.querySelector('a[href="#checker"]').classList.remove('active');
        }

        const urlParams = new URLSearchParams(window.location.search);
        const urlPage = urlParams.get('page');

        const claimIndex = targetClaimId - 1;
        const targetPage = getPageForIndex(claimIndex);

        if (urlPage && paginationEnabled) {
          currentPage = parseInt(urlPage);
          if (currentPage > totalPages) currentPage = totalPages;
          if (currentPage < 1) currentPage = 1;
        } else if (paginationEnabled && currentPage !== targetPage) {
          currentPage = targetPage;
        }

        updateTable(() => {
          setTimeout(() => {
            const element = document.getElementById(`claim-${targetClaimId}`);
            if (element) {
              element.scrollIntoView({ behavior: 'smooth', block: 'center' });
              element.style.transition = 'background-color 0.5s ease';
              const originalBg = element.style.background;
              element.style.background = 'rgba(37, 99, 235, 0.2)';
              setTimeout(() => {
                element.style.background = originalBg;
              }, 2000);
            }
          }, 100);
        });
      }

      function checkUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const claimParam = urlParams.get('claim');

        if (claimParam) {
          const claimId = parseInt(claimParam);
          if (!isNaN(claimId) && claimId > 0) {
            // Ensure we're in dashboard view
            if (document.getElementById('dashboard-view').classList.contains('hidden')) {
              switchView('dashboard');
              document.querySelector('a[href="#dashboard"]').classList.add('active');
              document.querySelector('a[href="#checker"]').classList.remove('active');
            }

            if (paginationEnabled) {
              const targetPage = getPageForIndex(claimId - 1);
              currentPage = targetPage;
            }

            updateTable(() => {
              setTimeout(() => {
                const element = document.getElementById(`claim-${claimId}`);
                if (element) {
                  element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  element.style.transition = 'background-color 0.5s ease';
                  const originalBg = element.style.background;
                  element.style.background = 'rgba(37, 99, 235, 0.2)';
                  setTimeout(() => {
                    element.style.background = originalBg;
                  }, 2000);
                }
              }, 100);
            });
          }
        }
      }

      async function fetchData(url=DATA_URL) {
        try {
          const response = await fetch(url, { cache: "no-cache" });
          if (response.ok) {
            const data = await response.json();
            return data;
          }
          console.error("Error fetching data: ", response.status);
          return [];
        } catch (error) {
          console.error("Error fetching data:", error);
          return [];
        }
      }

      function togglePaginationControls() {
        const controlsContainer = document.getElementById('paginationControls');
        controlsContainer.innerHTML = '';

        if (paginationEnabled) {
          const paginationDiv = document.createElement('div');
          paginationDiv.className = 'pagination';

          const firstButton = document.createElement('button');
          firstButton.id = 'firstPage';
          firstButton.textContent = '««';
          firstButton.addEventListener('click', () => {
            currentPage = 1;
            updateTable();
          });

          const prevButton = document.createElement('button');
          prevButton.id = 'prevPage';
          prevButton.textContent = '«';
          prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
              currentPage--;
              updateTable();
            }
          });

          const pageInfo = document.createElement('span');
          pageInfo.className = 'pagination-info';
          pageInfo.id = 'paginationInfo';
          pageInfo.textContent = `${currentPage}/${totalPages}`;

          const nextButton = document.createElement('button');
          nextButton.id = 'nextPage';
          nextButton.textContent = '»';
          nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
              currentPage++;
              updateTable();
            }
          });

          const lastButton = document.createElement('button');
          lastButton.id = 'lastPage';
          lastButton.textContent = '»»';
          lastButton.addEventListener('click', () => {
            currentPage = totalPages;
            updateTable();
          });

          firstButton.disabled = currentPage === 1;
          prevButton.disabled = currentPage === 1;
          nextButton.disabled = currentPage === totalPages;
          lastButton.disabled = currentPage === totalPages;

          paginationDiv.appendChild(firstButton);
          paginationDiv.appendChild(prevButton);
          paginationDiv.appendChild(pageInfo);
          paginationDiv.appendChild(nextButton);
          paginationDiv.appendChild(lastButton);

          const inProgressIndex = findInProgressIndex(allClaimsData);
          if (inProgressIndex >= 0) {
            const jumpButton = document.createElement('button');
            jumpButton.id = 'jumpToLatest';
            jumpButton.textContent = 'A';
            jumpButton.addEventListener('click', () => {
              currentPage = getPageForIndex(inProgressIndex);
              updateTable();
            });
            paginationDiv.appendChild(jumpButton);
          }

          controlsContainer.appendChild(paginationDiv);
        } else {
          const placeholder = document.createElement('div');
          placeholder.className = 'pagination-placeholder';
          controlsContainer.appendChild(placeholder);
        }
      }

      function initPagination() {
        const savedPaginationState = localStorage.getItem('patchcoinPaginationEnabled');
        if (savedPaginationState !== null) {
          paginationEnabled = savedPaginationState === 'true';
        }
        const paginationToggle = document.getElementById('paginationToggle');
        paginationToggle.checked = !paginationEnabled;
        togglePaginationControls();
        paginationToggle.addEventListener('change', function() {
          paginationEnabled = !this.checked;
          localStorage.setItem('patchcoinPaginationEnabled', paginationEnabled.toString());
          togglePaginationControls();
          updateTable();
        });
      }

      function updateTable(callback) {
        let filteredData = allClaimsData;
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        if (searchTerm) {
          filteredData = allClaimsData.filter(item => {
            return item.peercoin_address.toLowerCase().includes(searchTerm) ||
                   item.patchcoin_address.toLowerCase().includes(searchTerm) ||
                   new Date(item.nTime * 1000).toLocaleString().toLowerCase().includes(searchTerm);
          });
        }

        totalPages = Math.ceil(filteredData.length / rowsPerPage);
        if (currentPage > totalPages) {
          currentPage = totalPages || 1;
        }

        const dataToShow = paginationEnabled ? paginateData(filteredData) : filteredData;
        const tableBody = document.querySelector("#claimsTable tbody");
        tableBody.innerHTML = "";

        dataToShow.forEach((item, localIndex) => {
          const key = item.peercoin_address + '-' + item.patchcoin_address + '-' + item.nTime;
          const globalIndex = filteredData.indexOf(item);
          const claimId = getClaimIdFromGlobalIndex(globalIndex, filteredData);

          const rowId = paginationEnabled
            ? `claim-${claimId}`
            : `claim-${claimId}`;

          const row = document.createElement("tr");
          row.id = rowId;
          row.className = 'claim-row';

          const fillPercentage = item.patchcoin_eligible > 0
            ? Math.min((item.total_received / item.patchcoin_eligible) * 100, 100)
            : 0;
          row.style.background = `linear-gradient(to right, var(--fill-color) ${fillPercentage}%, transparent ${fillPercentage}%)`;
          const date = new Date(item.nTime * 1000).toLocaleString();

          row.innerHTML = `
            <td class="id-column">
              <span class="claim-id">${claimId}</span>
              <a class="claim-link" href="#claim-${claimId}" onclick="handleLinkCopy(event, ${claimId}, ${localIndex})">🔗</a>
            </td>
            <td>${date}</td>
            <td class="truncate" title="${item.peercoin_address}">
              ${truncatedAddress(item.peercoin_address)}
              <span class="full-address">${item.peercoin_address}</span>
            </td>
            <td class="truncate" title="${item.patchcoin_address}">
              ${truncatedAddress(item.patchcoin_address)}
              <span class="full-address">${item.patchcoin_address}</span>
            </td>
            <td class="number">${formatNumber(item.peercoin_balance)}</td>
            <td class="number">${formatNumber(item.patchcoin_eligible)}</td>
            <td class="number">${formatNumber(item.total_received)}</td>
            <td><button class="toggleRow" data-key="${key}">JSON</button></td>
          `;

          tableBody.appendChild(row);

          const detailRow = document.createElement("tr");
          detailRow.setAttribute('data-parent-id', rowId);
          detailRow.style.display = window.toggleStates[key] ? "table-row" : "none";
          const detailCell = document.createElement("td");
          detailCell.colSpan = 8;
          detailCell.style.background = "#f0f0f0";
          detailCell.innerHTML = `<pre style="margin:0;">${JSON.stringify(item, null, 2)}</pre>`;
          detailRow.appendChild(detailCell);
          tableBody.appendChild(detailRow);
        });

        document.querySelectorAll(".toggleRow").forEach(button => {
          button.addEventListener("click", function() {
            const key = this.dataset.key;
            const currentRow = this.parentElement.parentElement;
            const detailRow = currentRow.nextElementSibling;
            if (detailRow.style.display === "none" || detailRow.style.display === "") {
              detailRow.style.display = "table-row";
              window.toggleStates[key] = true;
            } else {
              detailRow.style.display = "none";
              window.toggleStates[key] = false;
            }
          });
        });

        togglePaginationControls();

        if (typeof callback === 'function') {
          callback();
        }
      }

      async function updateDashboard(forceUpdate = false) {
        if (!document.getElementById('dashboard-view').classList.contains('hidden')) {
          showToast('Checking for updates...', 1000);
        }

        const data = await fetchData();
        data.sort((a, b) => a.nTime - b.nTime);

        const dataChanged = hasDataChanged(data) || forceUpdate;

        if (!dataChanged) {
          if (!document.getElementById('dashboard-view').classList.contains('hidden')) {
            showToast('No changes detected in claims data', 2000);
          }
          return;
        }

        if (!document.getElementById('dashboard-view').classList.contains('hidden')) {
          showToast('Updating dashboard with new data...', 1500);
        }

        if (firstLoad) {
          const urlParams = new URLSearchParams(window.location.search);
          const urlPage = urlParams.get('page');
          if (urlPage) {
            currentPage = parseInt(urlPage);
          }
        }

        if (firstLoad) {
          const inProgressIndex = findInProgressIndex(data);
          currentPage = inProgressIndex >= 0 ? getPageForIndex(inProgressIndex) : 1;
          firstLoad = false;
        }

        lastData = data;
        window.sortedClaims = data;
        allClaimsData = data;
        totalPages = Math.ceil(allClaimsData.length / rowsPerPage);

        if (currentPage > totalPages) {
          currentPage = totalPages || 1;
        }

        const times = [];
        const cumulativeEligible = [];
        const cumulativeReceived = [];
        const cumulativePeercoin = [];
        let totalEligible = 0;
        let totalReceived = 0;
        let totalPeercoin = 0;

        claimsAddressSet = new Set(data.map(entry => entry.peercoin_address));

        allClaimsData.forEach(item => {
          totalEligible += item.patchcoin_eligible;
          cumulativeEligible.push(totalEligible);
          totalReceived += item.total_received;
          cumulativeReceived.push(totalReceived);
          totalPeercoin += item.peercoin_balance;
          cumulativePeercoin.push(totalPeercoin);
          const date = new Date(item.nTime * 1000);
          times.push(date.toLocaleString());
        });

        const chartConfig = {
          type: 'line',
          data: {
            labels: times,
            datasets: [
              {
                label: 'Cumulative Eligible',
                data: cumulativeEligible,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0
              },
              {
                label: 'Cumulative Received',
                data: cumulativeReceived,
                borderColor: '#16a34a',
                backgroundColor: 'rgba(144, 238, 144, 0.2)',
                fill: true,
                tension: 0,
                pointRadius: 0,
                borderWidth: 2
              },
              {
                label: 'Peercoins Used',
                data: cumulativePeercoin,
                borderColor: '#f59e0b',
                backgroundColor: 'transparent',
                fill: true,
                tension: 0,
                pointRadius: 0,
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  maxTicksLimit: window.innerWidth < 768 ? 5 : 10,
                  maxRotation: 45,
                  minRotation: 45
                }
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0, 0, 0, 0.1)' },
                ticks: { callback: (value) => formatNumber(value) }
              }
            },
            plugins: {
              tooltip: {
                enabled: false,
                external: function(context) {
                  let tooltipEl = document.getElementById('chartjs-tooltip');
                  if (!tooltipEl) {
                    tooltipEl = document.createElement('div');
                    tooltipEl.id = 'chartjs-tooltip';
                    document.body.appendChild(tooltipEl);
                  }
                  const tooltipModel = context.tooltip;
                  if (tooltipModel.opacity === 0) {
                    tooltipEl.style.opacity = 0;
                    return;
                  }
                  tooltipEl.innerHTML = createTooltipHtml(tooltipModel.dataPoints);
                  const position = context.chart.canvas.getBoundingClientRect();
                  tooltipEl.style.position = 'absolute';
                  tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                  tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
                  tooltipEl.style.opacity = 1;
                  tooltipEl.style.pointerEvents = 'none';
                }
              },
              legend: { labels: { usePointStyle: true, padding: 20 } }
            }
          }
        };

        if (chart) {
          chart.destroy();
        }

        const ctx = document.getElementById('claimsChart').getContext('2d');
        chart = new Chart(ctx, chartConfig);

        const eligiblePercent = Math.min((totalEligible / CAP) * 100, 100);
        const receivedPercent = Math.min((totalReceived / CAP) * 100, 100);
        const peercoinPercent = Math.min((totalPeercoin / 29405803) * 100, 100);
        document.getElementById('capProgressEligible').style.width = eligiblePercent + '%';
        document.getElementById('capProgressReceived').style.width = receivedPercent + '%';
        document.getElementById('capProgressPeercoin').style.width = peercoinPercent + '%';
        document.getElementById('eligiblePercent').textContent = eligiblePercent.toFixed(2) + '%';
        document.getElementById('receivedPercent').textContent = receivedPercent.toFixed(2) + '%';
        document.getElementById('peercoinPercent').textContent = peercoinPercent.toFixed(2) + '%';
        document.getElementById('eligibleSubtitle').textContent = `${formatNumber(totalEligible)} / ${formatNumber(CAP)}`;
        document.getElementById('receivedSubtitle').textContent = `${formatNumber(totalReceived)} / ${formatNumber(CAP)}`;
        document.getElementById('peercoinSubtitle').textContent = `${formatNumber(totalPeercoin)} / ${formatNumber(29405803)}`;

        updateTable(() => {
          const hash = window.location.hash.substring(1);
          if (hash.startsWith('claim-')) {
            scrollToClaimFromHash();
          } else {
            checkUrlParams();
          }
        });
      }

      let referenceSetMap = null;

      async function loadReferenceSet() {
        if (referenceSetMap !== null) {
          return referenceSetMap;
        }

        document.getElementById('status').textContent = 'Loading reference set...';

        try {
          const response = await fetch(REFERENCE_SET, { cache: "no-cache" });
          if (!response.ok) {
            throw new Error(`Failed to load reference set: ${response.status}`);
          }

          const data = await response.json();
          referenceSetMap = new Map();

          if (Array.isArray(data)) {
            for (const entry of data) {
              if (typeof entry === 'object' && entry !== null) {
                const address = entry.address;
                const balance = entry.amount || entry.balance || entry.value || 0;
                if (address) {
                  referenceSetMap.set(address, balance);
                }
              }
            }
          } else if (typeof data === 'object' && data !== null) {
            for (const [address, balance] of Object.entries(data)) {
              referenceSetMap.set(address, balance);
            }
          }

          return referenceSetMap;
        } catch (error) {
          console.error("Error loading reference set:", error);
          document.getElementById('status').textContent = `Error loading reference set: ${error.message}`;
          document.getElementById('status').className = 'output-status status-warning';
          return new Map();
        }
      }

      async function checkAddresses(inputType) {
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('status').textContent = 'Checking addresses...';
        document.getElementById('status').className = 'output-status';

        if (!claimsAddressSet) {
          await updateDashboard();
        }

        const referenceSet = await loadReferenceSet();

        let inputAddresses = new Set();

        try {
          if (inputType === 'text') {
            let inputText = document.getElementById("addressInput").value.trim();
            if (!inputText) {
              throw new Error("Please enter at least one address.");
            }
            inputAddresses = new Set(inputText.split(/[\s,]+/).filter(addr => addr));
          } else if (inputType === 'json') {
            let inputText = document.getElementById("jsonInput").value.trim();
            if (!inputText) {
              throw new Error("Please enter JSON data.");
            }
            try {
              let jsonData = JSON.parse(inputText);
              if (!Array.isArray(jsonData)) {
                throw new Error("Invalid JSON format. Expected an array.");
              }
              inputAddresses = new Set(jsonData.map(entry => entry.address).filter(addr => addr));
            } catch (error) {
              throw new Error("Invalid JSON format: " + error.message);
            }
          } else if (inputType === 'file') {
            let file = document.getElementById("jsonFile").files[0];
            if (!file) {
              throw new Error("Please upload a JSON file.");
            }

            try {
              let text = await file.text();
              let jsonData = JSON.parse(text);
              if (!Array.isArray(jsonData)) {
                throw new Error("Invalid JSON format. Expected an array.");
              }
              inputAddresses = new Set(jsonData.map(entry => entry.address).filter(addr => addr));
            } catch (error) {
              throw new Error("Invalid JSON file: " + error.message);
            }
          }

          if (inputAddresses.size === 0) {
            throw new Error("No valid addresses found in the input.");
          }

          const results = [...inputAddresses].map(addr => {
            const inClaims = claimsAddressSet.has(addr);
            const inReferenceSet = referenceSet.has(addr);
            const balance = inReferenceSet ? referenceSet.get(addr) : null;

            return {
              address: addr,
              inClaims,
              inReferenceSet,
              balance
            };
          });

          const missingFromClaims = results.filter(r => !r.inClaims);
          const missingFromReference = results.filter(r => !r.inReferenceSet);
          const missingFromBoth = results.filter(r => !r.inClaims && !r.inReferenceSet);

          const statusEl = document.getElementById('status');
          const outputEl = document.getElementById('output');

          let statusMessage = '';
          if (missingFromClaims.length === 0 && missingFromReference.length === 0) {
            statusMessage = `Success! All ${inputAddresses.size} addresses are in both claims and reference set.`;
            statusEl.className = 'output-status status-success';
          } else {
            statusMessage = `Found ${missingFromClaims.length} addresses missing from claims`;
            if (missingFromReference.length > 0) {
              statusMessage += ` and ${missingFromReference.length} missing from reference set`;
            }
            if (missingFromBoth.length > 0) {
              statusMessage += ` (${missingFromBoth.length} missing from both)`;
            }
            statusMessage += '.';
            statusEl.className = 'output-status status-warning';
          }
          statusEl.textContent = statusMessage;

          results.sort((a, b) => {
            const aInBoth = a.inClaims && a.inReferenceSet ? 1 : 0;
            const bInBoth = b.inClaims && b.inReferenceSet ? 1 : 0;

            if (bInBoth !== aInBoth) {
              return bInBoth - aInBoth;
            }

            if (a.inClaims !== b.inClaims) {
              return a.inClaims ? -1 : 1;
            }

            if (a.inReferenceSet !== b.inReferenceSet) {
              return a.inReferenceSet ? -1 : 1;
            }

            return a.address.localeCompare(b.address);
          });

          let tableHtml = `<table class="results-table" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f2f2f2;">
                  <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Address</th>
                  <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">In Reference</th>
                  <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Peercoin Balance</th>
                  <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">In Claims</th>
                </tr>
              </thead>
              <tbody>`;

          for (const result of results) {
            const rowStyle = result.inClaims && result.inReferenceSet
              ? 'background-color: #e6ffe6;'
              : (!result.inClaims && !result.inReferenceSet
                ? 'background-color: #ffe6e6;'
                : '');

            tableHtml += `<tr style="${rowStyle}">
                <td style="padding: 8px; text-align: left; border: 1px solid #ddd; font-family: monospace;">${result.address}</td>
                <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${result.inReferenceSet ? 'Yes' : 'No'}</td>
                <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${result.inReferenceSet ? formatNumber(result.balance) : 'Not Found'}</td>
                <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${result.inClaims ? 'Yes' : 'No'}</td>
              </tr>`;
          }

          tableHtml += `</tbody>
            </table>`;

          outputEl.innerHTML = tableHtml;
        } catch (error) {
          document.getElementById('status').textContent = `Error: ${error.message}`;
          document.getElementById('status').className = 'output-status status-warning';
          document.getElementById('output').textContent = 'Please correct the error and try again.';
        } finally {
          document.getElementById('loader').classList.add('hidden');
        }
      }

      function switchTab(tabId, tabElement) {
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });

        document.getElementById(tabId).classList.add('active');

        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });

        tabElement.classList.add('active');
      }

      function switchView(viewId, event) {
        if (event) {
          event.preventDefault();

          document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
          });
          event.target.classList.add('active');
        }

        document.getElementById('dashboard-view').classList.add('hidden');
        document.getElementById('checker-view').classList.add('hidden');

        document.getElementById(viewId + '-view').classList.remove('hidden');

        window.location.hash = viewId;

        if (viewId === 'dashboard' && chart) {
          setTimeout(() => {
            chart.resize();
          }, 0);
        }
      }

      function checkUrlHash() {
        const hash = window.location.hash.substring(1);
        const urlParams = new URLSearchParams(window.location.search);
        const claimParam = urlParams.get('claim');

        if (hash === 'checker') {
          switchView('checker');
          document.querySelector('a[href="#checker"]').classList.add('active');
          document.querySelector('a[href="#dashboard"]').classList.remove('active');
          toggleUpdates(true);
        } else if (hash.startsWith('claim-')) {
          switchView('dashboard');
          document.querySelector('a[href="#dashboard"]').classList.add('active');
          document.querySelector('a[href="#checker"]').classList.remove('active');
          toggleUpdates(false);
        } else {
          switchView('dashboard');
          document.querySelector('a[href="#dashboard"]').classList.add('active');
          document.querySelector('a[href="#checker"]').classList.remove('active');
          toggleUpdates(false);

          if (claimParam) {
            checkUrlParams();
          }
        }
      }

      window.handleLinkCopy = handleLinkCopy;

      window.addEventListener('hashchange', () => {
        checkUrlHash();

        const hash = window.location.hash.substring(1);
        if (hash.startsWith('claim-')) {
          scrollToClaimFromHash();
        } else if (hash === 'dashboard') {
          checkUrlParams();
        }
      });

      function toggleUpdates(shouldPause) {
        if (shouldPause) {
          if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = null;
          }
          updatesPaused = true;
          document.getElementById('updateStatus').textContent = 'Updates paused';
          document.getElementById('toggleUpdatesBtn').textContent = 'Resume Updates';
        } else {
          if (!updateInterval) {
            updateInterval = setInterval(() => updateDashboard(false), 60000);
          }
          updatesPaused = false;
          document.getElementById('updateStatus').textContent = 'Auto-updates every 60 seconds';
          document.getElementById('toggleUpdatesBtn').textContent = 'Pause Updates';
        }
      }

      initPagination();
      checkUrlHash();
      updateDashboard(true);
      updateInterval = setInterval(() => updateDashboard(false), 60000);

      window.addEventListener('resize', () => {
        if (chart) {
          chart.resize();
        }
      });

      document.getElementById('searchInput').addEventListener('input', updateTable);
    </script>
  </body>
</html>
